<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: 260px;
      background: #1a1f36;
      color: white;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      height: 100vh;
      flex-shrink: 0;
      z-index: 100;
      overflow: hidden;
      transition: width 0.3s ease;
    }

    .sidebar.collapsed {
      width: 70px;
    }

    .sidebar.collapsed .nav-item span {
      display: none;
    }

    /* Center icons when collapsed */
    .sidebar.collapsed .nav-item {
      justify-content: center;
    }

    .sidebar.collapsed .nav-item i {
      margin-right: 0;
    }

    .sidebar.collapsed .sidebar-logo h3 {
      display: none;
    }

    .sidebar.collapsed .logout-btn span {
      display: none;
    }

    .sidebar.collapsed .logout-btn {
      justify-content: center;
    }

    .sidebar.collapsed .logout-btn i {
      margin-right: 0;
    }

    .nav-toggle {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
    }

    .sidebar-logo {
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #2d3245;
      gap: 10px;
    }

    .sidebar-logo h3 {
      font-size: 20px;
      font-weight: 600;
      color: #1976d2;
    }

    .nav-menu {
      flex: 1;
      padding: 20px 0;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #1976d2 #2d3245;
    }

    .nav-menu::-webkit-scrollbar {
      width: 6px;
    }

    .nav-menu::-webkit-scrollbar-track {
      background: #2d3245;
    }

    .nav-menu::-webkit-scrollbar-thumb {
      background: #1976d2;
      border-radius: 3px;
    }

    .nav-menu::-webkit-scrollbar-thumb:hover {
      background: #1565c0;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      color: #b0b3b8;
      text-decoration: none;
      transition: all 0.3s ease;
      cursor: pointer;
      border-left: 4px solid transparent;
    }

    .nav-item:hover {
      background: #252d45;
      color: #1976d2;
      border-left-color: #1976d2;
    }

    .nav-item i {
      margin-right: 12px;
      font-size: 18px;
    }

    .nav-item.active {
      background: #1976d2;
      color: white;
      border-left-color: #1976d2;
    }

    .sidebar-footer {
      padding: 15px 20px;
      border-top: 1px solid #2d3245;
    }

    .logout-btn {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 12px 15px;
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #b71c1c;
      transform: translateY(-2px);
    }

    .logout-btn i {
      margin-right: 8px;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #113c67 0%, #1b5fab 100%);
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-left h2 {
      font-size: 24px;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo-container {
      background: white;
      padding: 8px 15px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-container img {
      max-width: 120px;
      height: auto;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-info i {
      font-size: 24px;
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 12px;
      border-radius: 6px;
    }

    .content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
    }

    .welcome-card {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
    }

    .welcome-card h3 {
      color: #1976d2;
      font-size: 24px;
      margin-bottom: 10px;
    }

    .welcome-card p {
      color: #666;
      font-size: 16px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .dashboard-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .dashboard-card i {
      font-size: 40px;
      color: #1976d2;
      margin-bottom: 15px;
    }

    .dashboard-card h4 {
      color: #333;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .dashboard-card p {
      color: #666;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .dashboard-card .btn {
      display: inline-block;
      padding: 10px 20px;
      background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }

    .dashboard-card .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .section-title {
      color: #1976d2;
      font-size: 28px;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .section-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .section-content p {
      color: #666;
      font-size: 16px;
      line-height: 1.6;
    }

    /* Projects Section Styling */
    .projects-container {
      display: grid;
      grid-template-columns: 173px 186px 1fr;
      gap: 10px;
      height: calc(100vh - 150px);
      width: 100%;
    }

    .projects-list {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
      height: 100%;
    }

    .projects-list-header {
      flex-shrink: 0;
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
    }

    .projects-items-wrapper {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .project-item {
      padding: 15px 20px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .project-item:hover {
      background: #f9f9f9;
      border-left-color: #1976d2;
    }

    .project-item.active {
      background: #e3f2fd;
      border-left-color: #1976d2;
    }

    .project-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
      font-size: 15px;
    }

    .project-status {
      font-size: 12px;
      color: #999;
    }

    .assign-btn-list {
      color: #1976d2;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      background: none;
      border: none;
    }

    .assign-btn-list:hover {
      background: rgba(25, 118, 210, 0.1);
    }

    .project-details {
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
    }

    .project-detail-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      padding: 25px;
      overflow-y: auto;
      min-width: 0;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid #f0f0f0;
    }

    .detail-left h3 {
      color: #333;
      font-size: 22px;
      margin-bottom: 8px;
      margin: 0 0 8px 0;
    }

    .detail-left p {
      color: #666;
      font-size: 14px;
      line-height: 1.5;
      margin: 0;
    }

    .detail-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .detail-badge {
      display: inline-block;
      padding: 6px 14px;
      background: #4caf50;
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .detail-badge.in-progress {
      background: #ffc107;
      color: #333;
    }

    .detail-badge.completed {
      background: #4caf50;
    }

    .detail-progress {
      font-size: 12px;
      color: #999;
      font-weight: 600;
    }

    .assigned-users {
      margin-bottom: 20px;
    }

    .assigned-users h4 {
      color: #333;
      font-size: 16px;
      margin-bottom: 15px;
      margin: 0 0 15px 0;
    }

    .users-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .user-badge {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
      background: #f5f5f5;
      border-radius: 8px;
      text-align: left;
    }

    .user-badge i {
      font-size: 28px;
      color: #1976d2;
    }

    .user-badge span {
      font-weight: 600;
      color: #333;
      font-size: 13px;
    }

    .user-badge small {
      font-size: 11px;
      color: #999;
    }

    .project-tasks {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      padding: 25px;
      overflow: auto;
      min-width: 0;
    }

    .project-tasks h4 {
      color: #333;
      font-size: 18px;
      margin-bottom: 20px;
      margin: 0 0 20px 0;
    }

    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .users-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
    }

    .tasks-header h4 {
      color: #333;
      font-size: 18px;
      margin: 0;
    }

    .add-task-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      padding: 0;
      background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-weight: 600;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .add-task-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(25, 118, 210, 0.4);
    }

    .add-task-btn i {
      font-size: 18px;
    }

    .tasks-table {
      width: 100%;
      border-collapse: collapse;
    }

    .tasks-table thead {
      background: #f9f9f9;
    }

    .tasks-table th {
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #e0e0e0;
      font-size: 13px;
    }

    .tasks-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
      color: #666;
      font-size: 14px;
    }

    .tasks-table tbody tr:hover {
      background: #f9f9f9;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-badge.completed {
      background: #c8e6c9;
      color: #2e7d32;
    }

    .status-badge.in-progress {
      background: #fff3cd;
      color: #856404;
    }

    .status-badge.pending {
      background: #e0e0e0;
      color: #666;
    }

    .priority-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .priority-badge.high {
      background: #ffcdd2;
      color: #c62828;
    }

    .priority-badge.medium {
      background: #fff9c4;
      color: #f57f17;
    }

    .priority-badge.low {
      background: #b3e5fc;
      color: #01579b;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #1976d2;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #1565c0;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      background: #ffffff;
      margin: 8% auto;
      padding: 20px;
      width: 360px;
      border-radius: 6px;
      position: relative;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }

    .modal-content h3 {
      margin-top: 0;
      text-align: center;
    }

    .close {
      position: absolute;
      right: 12px;
      top: 8px;
      font-size: 22px;
      cursor: pointer;
      color: #999;
    }

    .close:hover {
      color: #333;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 7px;
      font-size: 13px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #1976d2;
    }

    .submit-btn {
      width: 100%;
      padding: 10px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .submit-btn:hover {
      background: #1565c0;
    }

    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #1976d2;
      font-size: 14px;
      padding: 4px 8px;
    }

    .action-btn:hover {
      color: #1565c0;
    }

    .add-project-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      padding: 0;
      background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-weight: 600;
      font-size: 18px;
      transition: all 0.2s ease;
    }

    .add-project-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
    }

    /* Toast Styles */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4caf50;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      font-size: 14px;
      font-weight: 600;
      animation: slideInDown 0.3s ease;
      z-index: 3000;
    }

    .toast.error {
      background: #f44336;
    }

    @keyframes slideInDown {
      from {
        transform: translateY(-100px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }

    /* Task Action Modal (Tabs) */
    .modal-tab {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 3000;
      background: rgba(0, 0, 0, 0.45);
      align-items: center;
      justify-content: center;
    }

    .modal-content-tab {
      width: 550px;
      background: white;
      border-radius: 8px;
      padding-bottom: 15px;
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.25);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }

    .close-tab {
      position: absolute;
      right: 14px;
      top: 8px;
      font-size: 22px;
      cursor: pointer;
      color: #666;
    }

    .close-tab:hover {
      color: #333;
    }

    .tab-nav {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin: 0;
      padding: 0;
      list-style: none;
      justify-content: center;
      background: #f8f9fa;
      border-radius: 8px 8px 0 0;
    }

    .tab-nav li {
      padding: 12px 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #555;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab-nav li:hover {
      background: #eee;
    }

    .tab-nav li.active {
      color: #1976d2;
      border-bottom-color: #1976d2;
      background: white;
    }

    .tab-container {
      padding: 20px;
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    /* Comments & Activity */
    .comments-container,
    .activity-container {
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      background: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #eee;
      margin-bottom: 10px;
    }

    .comment-item,
    .activity-item {
      background: white;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 13px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 12px;
      color: #555;
    }

    .comment-header strong {
      color: #1976d2;
    }

    /* Workflow Status */
    .workflow-status-container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 30px 0;
      position: relative;
    }

    .workflow-status-container::before {
      content: '';
      position: absolute;
      top: 30px;
      left: 10%;
      right: 10%;
      height: 2px;
      background: #e0e0e0;
      z-index: 0;
    }

    .workflow-status-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 1;
      position: relative;
    }

    .workflow-status-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 2px solid #ddd;
      background: white;
      color: #777;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      text-align: center;
      transition: all 0.3s;
    }

    .workflow-status-box.active .workflow-status-circle {
      background: #4caf50;
      color: white;
      border-color: #4caf50;
      box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
    }

    .workflow-next-btn {
      width: 100%;
      padding: 12px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    .workflow-next-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Assign User Modal Styles */
    .assign-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 15px;
    }

    .assign-box {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    .assign-box h4 {
      margin-top: 0;
      font-size: 16px;
      margin-bottom: 10px;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }

    .assign-user-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f5f5f5;
    }

    .assign-user-row:last-child {
      border-bottom: none;
    }

    .assign-user-row span {
      font-size: 14px;
      color: #333;
    }

    .assign-action-btn {
      border: none;
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 3px;
      cursor: pointer;
      color: white;
      transition: opacity 0.2s;
    }

    .assign-action-btn:hover {
      opacity: 0.9;
    }

    .btn-assign {
      background: #4caf50;
    }

    .btn-unassign {
      background: #f44336;
    }

    .assign-empty {
      font-size: 13px;
      color: #999;
      text-align: center;
      padding: 10px;
    }

    .pagination-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      gap: 10px;
    }

    .page-btn {
      padding: 6px 14px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      color: #555;
      transition: all 0.2s;
    }

    .page-btn:hover:not(:disabled) {
      background: #f0f0f0;
      border-color: #ccc;
      color: #333;
    }

    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f9f9f9;
    }

    .page-info {
      font-size: 13px;
      color: #666;
      font-weight: 500;
    }

    .tasks-body {
      flex: 1;
      overflow-y: auto;
    }

    .task-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .task-table th {
      text-align: left;
      padding: 10px;
      background: #f8f9fa;
      color: #555;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    .task-table td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      color: #333;
    }

    .task-table tr:hover {
      background: #f9f9f9;
    }

    .badge {
      padding: 5px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-block;
      letter-spacing: 0.5px;
    }

    .badge-priority-high {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ffcdd2;
    }

    .badge-priority-medium {
      background: #fff3e0;
      color: #ef6c00;
      border: 1px solid #ffe0b2;
    }

    .badge-priority-low {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }

    .badge-status-todo {
      background: #f5f5f5;
      color: #616161;
      border: 1px solid #e0e0e0;
    }

    .badge-status-in-progress {
      background: #e3f2fd;
      color: #1565c0;
      border: 1px solid #bbdefb;
    }

    .badge-status-under-review {
      background: #fff8e1;
      color: #f57f17;
      border: 1px solid #ffecb3;
    }

    .badge-status-done {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }

    .badge-status-overdue {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ffcdd2;
    }

    .overdue-badge {
      background: #ff4d4d;
      color: white;
      font-size: 7px;
      padding: 2px 3px;
      border-radius: 5px;
      margin-left: 2px;
    }

    .empty {
      text-align: center;
      color: #888;
      font-size: 14px;
    }

    .empty-comments {
      color: #777;
      font-size: 14px;
      text-align: center;
      padding: 10px;
    }

    .row-overdue {
      background: #ffe6e6 !important;
    }

    .task-filters {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
      margin-right: 15px;
      /* aligns right before Add button */
    }

    .task-filters select,
    .task-filters input {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 5px 7px;
      font-size: 13px;
    }

    .filter-hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div class="sidebar collapsed">
    <div class="sidebar-logo">
      <button id="navToggle" class="nav-toggle">
        <i class="fas fa-arrow-right"></i>
      </button>
      <h3>MedKart</h3>
    </div>

    <nav class="nav-menu">
      <a href="#" class="nav-item" data-section="projects">
        <i class="fas fa-folder"></i>
        <span>Projects</span>
      </a>
      <a href="#" class="nav-item" data-section="users">
        <i class="fas fa-users"></i>
        <span>Users</span>
      </a>
      <a href="#" class="nav-item" data-section="roles">
        <i class="fas fa-user-shield"></i>
        <span>Roles</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <form method="post" action="/logout" style="width: 100%">
        {% csrf_token %}
        <button type="submit" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <div class="logo-container">
          <img src="https://d1s24u4ln0wd0i.cloudfront.net/website/new_ecom_asset/logo1.webp" alt="Medkart Logo" />
        </div>
        <h2 class="page-title">Projects</h2>
      </div>
      <div class="header-right">
        <div class="user-info">
          <i class="fas fa-user-circle"></i>
          <span>{{ request.session.username }}</span>
        </div>
      </div>
    </div>

    <!-- Content Area -->
    <div class="content">
      <!-- Tasks Section -->
      <div id="tasks-section" class="section">
        <div class="dashboard-grid">
          <div class="dashboard-card">
            <h3>Total Tasks</h3>
            <p class="card-number">24</p>
          </div>
          <div class="dashboard-card">
            <h3>Completed Tasks</h3>
            <p class="card-number">18</p>
          </div>
          <div class="dashboard-card">
            <h3>Pending Tasks</h3>
            <p class="card-number">6</p>
          </div>
        </div>
      </div>

      <!-- Projects Section -->
      <div id="projects-section" class="section active">
        <div class="projects-container">
          <!-- Left Column: Projects List (1 col) -->
          <div class="projects-list">
            <div class="projects-list-header" style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  padding: 20px;
                  border-bottom: 1px solid #f0f0f0;
                ">
              <h3 style="margin: 0; font-size: 18px; color: #333">
                Projects
              </h3>
              <button id="addProjectBtn" class="add-project-btn" title="Add Project">
                +
              </button>
            </div>
            <div class="projects-items-wrapper">

            </div>
          </div>

          <!-- Middle Column: Project Details & Users (2 cols) -->
          <div class="project-detail-card">
            <div id="projectInfo" data-project-id=""></div>

            <div class="detail-header">
              <div class="detail-left">
                <h3 id="detail-project-name">Website Redesign</h3>
                <p id="detail-project-desc">
                  Complete redesign of company website with modern UI/UX
                </p>
              </div>
            </div>

            <!-- Assigned Users -->
            <div class="assigned-users">
              <h4>Assigned Users</h4>
              <div class="users-list"></div>
            </div>
          </div>

          <!-- Right Column: Tasks Table (10 cols) -->
          <div class="project-tasks">
            <div class="tasks-header">
              <h4>Tasks</h4>
              <div class="task-filters">
                <select id="searchType">
                  <option value="title">Title</option>
                  <option value="priority">Priority</option>
                  <option value="status">Status</option>
                </select>

                <input type="text" id="searchInput" placeholder="Search title..." />

                <select id="priorityFilter" class="filter-hidden">
                  <option value="">All</option>
                  <option value="high">High</option>
                  <option value="medium">Medium</option>
                  <option value="low">Low</option>
                </select>

                <select id="statusFilter" class="filter-hidden">
                  <option value="">All</option>
                  <option value="Todo">Todo</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Under Review">Under Review</option>
                  <option value="Done">Done</option>
                </select>
              </div>

              <button class="add-task-btn" id="addTaskBtn" title="Add Task">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <table class="tasks-table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Priority</th>
                  <th>Status</th>
                  <th>Assigned To</th>
                  <th>Due Date</th>
                  <th>Created by</th>
                  <th>Updated by</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="projectTasksBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Users Section -->
      <div id="users-section" class="section">
        <div class="projects-list" style="height: 100%; border-radius: 12px; overflow: hidden;">
          <div class="users-header">
            <h3 style="margin: 0; font-size: 18px; color: #333">Users</h3>
            <button id="openAddUserModalBtn" class="submit-btn" style="width: auto; padding: 8px 20px;">+ Add
              User</button>
          </div>
          <div class="projects-items-wrapper" style="flex: 1; overflow-y: auto; padding: 0;">
            <table class="tasks-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Full Name</th>
                  <th>Role</th>
                  <th>Created By</th>
                  <th>Created At</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <!-- Populated via JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Roles Section -->
      <div id="roles-section" class="section">
        <div class="projects-list" style="height: 100%; border-radius: 12px; overflow: hidden;">
          <div class="users-header">
            <h3 style="margin: 0; font-size: 18px; color: #333">Roles</h3>
            <button id="openAddRoleModalBtn" class="submit-btn" style="width: auto; padding: 8px 20px;">+ Add
              Role</button>
          </div>
          <div class="projects-items-wrapper" style="flex: 1; overflow-y: auto; padding: 0;">
            <table class="tasks-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="rolesTableBody">
                <!-- Populated via JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Task Modal -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Add Task</h3>
      <form id="taskForm">
        <div class="form-group">
          <label>Title</label>
          <input type="text" name="title" required />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea name="description" rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label>Priority</label>
          <select name="priority" required>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div class="form-group">
          <label>Due Date</label>
          <input type="date" name="due_date" required />
        </div>
        <div class="form-group">
          <label>Assign To</label>
          <select name="assigned_to" required>
            <option value="">-- Select User --</option>
          </select>
        </div>
        <button type="submit" class="submit-btn">Create Task</button>
      </form>
    </div>
  </div>

  <!-- Add Project Modal -->
  <div id="projectModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Create Project</h3>
      <form id="projectForm">
        <div class="form-group">
          <label>Title</label>
          <input type="text" name="title" required />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea name="description" rows="3"></textarea>
        </div>
        <button type="submit" class="submit-btn">Create Project</button>
      </form>
    </div>
  </div>

  <!-- Add User Modal -->
  <div id="addUserModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Create User</h3>
      <form id="addUserForm">
        <div class="form-group">
          <label>Username</label>
          <input type="text" name="username" id="u_username" required>
          <div id="u_usernameMsg" class="msg" style="font-size: 12px;"></div>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" name="password" id="u_password" required>
          <div id="u_passwordMsg" class="msg" style="font-size: 12px;"></div>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" name="email" id="u_email" required>
          <div id="u_emailMsg" class="msg" style="font-size: 12px;"></div>
        </div>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" name="fullname" required>
        </div>
        <div class="form-group">
          <label>Note</label>
          <input type="text" name="note">
        </div>
        <button type="submit" class="submit-btn" id="submitUserBtn">Create User</button>
      </form>
    </div>
  </div>

  <!-- Add Role Modal -->
  <div id="addRoleModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Add Role</h3>
      <form id="addRoleForm">
        <div class="form-group">
          <label>Role Name</label>
          <input type="text" name="role_name" required>
        </div>
        <button type="submit" class="submit-btn">Save Role</button>
      </form>
    </div>
  </div>

  <!-- Edit Role Modal -->
  <div id="editRoleModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Edit Role</h3>
      <form id="editRoleForm">
        <input type="hidden" name="role_id">
        <div class="form-group">
          <label>Role Name</label>
          <input type="text" name="role_name" required>
        </div>
        <button type="submit" class="submit-btn">Update Role</button>
      </form>
    </div>
  </div>

  <!-- Delete Role Modal -->
  <div id="deleteRoleModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Delete Role</h3>
      <p>Are you sure you want to delete this role?</p>
      <form id="deleteRoleForm">
        <input type="hidden" name="role_id">
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="submit" class="submit-btn" style="background: #d32f2f;">Yes, Delete</button>
          <button type="button" class="submit-btn" style="background: #ccc; color: #333;"
            id="cancelDeleteRoleBtn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Assign Users Modal
  <div id="assignUserModal" class="modal">
    <div class="modal-content" style="width: 700px; max-width: 90%;">
      <span class="close">&times;</span>
      <h3>Assign Users to Project</h3>
      <p id="assignProjectName" style="text-align: center; color: #666; margin-bottom: 20px;"></p>

      <div class="assign-grid" id="assignUserGrid">
        Populated via JS -->
  <!-- </div>
    </div>
  </div> -->

  <!-- Task Action Modal (Edit/Comments/Status/Activity) -->
  <div id="taskActionModal" class="modal-tab">
    <div class="modal-content-tab">
      <span class="close-tab">&times;</span>

      <ul class="tab-nav">
        <li class="active" data-tab="editTab">Edit</li>
        <li data-tab="commentTab">Comments</li>
        <li data-tab="statusTab">Status</li>
        <li data-tab="activityTab">Activity</li>
      </ul>

      <div class="tab-container">
        <!-- Edit Tab -->
        <div id="editTab" class="tab-pane active">
          <h3 style="margin-top:0; margin-bottom:15px;">Edit Task</h3>
          <form id="editTaskForm">
            <input type="hidden" name="task_id">
            <div class="form-group">
              <label>Title</label>
              <input type="text" name="title" required>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea name="description" rows="3" required></textarea>
            </div>
            <div class="form-group">
              <label>Priority</label>
              <select name="priority" required>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
              </select>
            </div>
            <div class="form-group">
              <label>Due Date</label>
              <input type="date" name="due_date" required>
            </div>
            <div class="form-group">
              <label>Assign To</label>
              <select name="assigned_to">
                <!-- Populated via JS -->
              </select>
            </div>
            <button type="submit" class="submit-btn">Save Changes</button>
          </form>
        </div>

        <!-- Comments Tab -->
        <div id="commentTab" class="tab-pane">
          <h3 style="margin-top:0;">Comments</h3>
          <div id="commentsList" class="comments-container"></div>
          <textarea id="newComment" rows="2" placeholder="Write a comment..."
            style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; margin-bottom:10px;"></textarea>
          <button id="sendCommentBtn" class="submit-btn" style="width:auto; padding:8px 20px;">Send</button>
        </div>

        <!-- Status Tab -->
        <div id="statusTab" class="tab-pane">
          <h3 style="margin-top:0; text-align:center;">Workflow Status</h3>
          <div class="workflow-status-container">
            <div class="workflow-status-box" id="status0">
              <div class="workflow-status-circle">To-Do</div>
            </div>
            <div class="workflow-status-box" id="status1">
              <div class="workflow-status-circle">In-Progress</div>
            </div>
            <div class="workflow-status-box" id="status2">
              <div class="workflow-status-circle">Under-Review</div>
            </div>
            <div class="workflow-status-box" id="status3">
              <div class="workflow-status-circle">Done</div>
            </div>
          </div>
          <div class="button-container">
            <button class="workflow-next-btn" id="nextBtn">Update Status</button>
          </div>
        </div>

        <!-- Activity Tab -->
        <div id="activityTab" class="tab-pane">
          <h3 style="margin-top:0;">Activity Log</h3>
          <div id="activityList" class="activity-container">
            <!-- Populated via JS -->
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const CSRF_TOKEN = "{{ csrf_token }}";
    let currentProjectId = null;

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function showToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.className = 'toast' + (isError ? ' error' : '');
      toast.textContent = message;
      document.body.appendChild(toast);

      // Auto-remove after 3 seconds
      setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

    $(document).ready(function () {
      const statusOrder = ["Todo", "In Progress", "Under Review", "Done"];
      // Initialize
      const projectsNavItem = document.querySelector(
        '[data-section="projects"]'
      );
      if (projectsNavItem) {
        projectsNavItem.classList.add("active");
      }

      // Load projects from API on page load
      loadProjectsList();

      // Handle Add Task button
      $("#addTaskBtn").on("click", function () {
        if (!currentProjectId) {
          alert("Please select a project first!");
          return;
        }

        // Load users for dropdown
        $.ajax({
          url:
            "/tasks/admin/project/api/get_project_userdetails/" +
            currentProjectId +
            "/",
          type: "GET",
          dataType: "json",
          success: function (response) {
            const $dropdown = $("select[name='assigned_to']");
            $dropdown.empty();
            $dropdown.append(`<option value="">-- Select User --</option>`);
            response.users.forEach((u) => {
              $dropdown.append(
                `<option value="${u.id}">${u.username}</option>`
              );
            });
            $("#taskModal").fadeIn(150);
          },
        });
      });

      // Close modal
      $("#taskModal .close").on("click", function () {
        $("#taskModal").fadeOut(150);
        $("#taskForm")[0].reset();
      });

      $("#taskForm").on("submit", function (e) {
        e.preventDefault();
        const payload = {
          title: $(this).find("[name='title']").val(),
          description: $(this).find("[name='description']").val(),
          priority: $(this).find("[name='priority']").val(),
          due_date: $(this).find("[name='due_date']").val(),
          assigned_to: $(this).find("[name='assigned_to']").val(),
          project_id: currentProjectId,
        };

        $.ajax({
          url: "/tasks/admin/task/api/create/",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(payload),
          headers: { "X-CSRFToken": CSRF_TOKEN },
          success: function (res) {
            showToast("Task created successfully!");
            $("#taskModal").fadeOut(150);
            $("#taskForm")[0].reset();
            // Reload project details to show new task
            loadProjectDetail(currentProjectId);
          },
          error: function (xhr) {
            showToast("Error creating task: " + xhr.responseText, true);
          },
        });
      });

      // ------- Task Action Modal Logic -------
      let selectedTaskId = null;

      // Open Modal
      $(document).on("click", ".action-btn", function () {

        selectedTaskId = $(this).data("task-id");
        if (!selectedTaskId) return;
        $("#taskActionModal").data("task-id", selectedTaskId);

        // Reset tabs
        $(".tab-nav li").removeClass("active");
        $("[data-tab='editTab']").addClass("active");
        $(".tab-pane").removeClass("active");
        $("#editTab").addClass("active");

        // Load Data
        loadTaskEdit(selectedTaskId);

        $("#taskActionModal").css("display", "flex").hide().fadeIn(150);
      });

      // Close Modal
      $(".close-tab").on("click", function () {
        $("#taskActionModal").fadeOut(150);
      });

      // Tab Switching
      $(".tab-nav li").click(function () {
        $(".tab-nav li").removeClass("active");
        $(this).addClass("active");
        $(".tab-pane").removeClass("active");
        $("#" + $(this).data("tab")).addClass("active");

        const tId = $("#taskActionModal").data("task-id");

        // Load specific tab data if needed
        if ($(this).data("tab") === "commentTab") loadComments(tId);
        if ($(this).data("tab") === "statusTab") loadStatusFlow(tId);
        if ($(this).data("tab") === "activityTab") loadActivityLog(tId);
      });

      // --- Edit Task ---
      function loadTaskEdit(taskId) {
        if (!taskId) return;
        $.get(`/tasks/user/api/task/get_task_details/${taskId}/`, function (res) {
          const form = $("#editTaskForm");
          form.find("input[name=task_id]").val(res.id);
          form.find("input[name=title]").val(res.title);
          form.find("textarea[name=description]").val(res.description);
          form.find("select[name=priority]").val(res.priority);
          form.find("input[name=due_date]").val(res.due_date);

          // Load users for dropdown (reusing project users endpoint)
          loadAssignDropdown(res.assigned_to, currentProjectId);
        });
      }

      function loadAssignDropdown(selectedId, projectId) {
        $.get(`/tasks/admin/project/api/get_project_userdetails/${projectId}/`, function (res) {
          const dropdown = $("#editTaskForm select[name=assigned_to]");
          dropdown.empty();
          dropdown.append(`<option value="">-- None --</option>`);
          res.users.forEach(u => {
            dropdown.append(`<option value="${u.id}" ${selectedId == u.id ? 'selected' : ''}>${u.username}</option>`);
          });
        });
      }

      $("#editTaskForm").on("submit", function (e) {
        e.preventDefault();
        const payload = {
          task_id: $(this).find("input[name=task_id]").val(),
          title: $(this).find("input[name=title]").val(),
          description: $(this).find("textarea[name=description]").val(),
          priority: $(this).find("select[name=priority]").val(),
          due_date: $(this).find("input[name=due_date]").val(),
          assigned_to: $(this).find("select[name=assigned_to]").val()
        };

        $.ajax({
          url: "/tasks/api/task/update/",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(payload),
          headers: { "X-CSRFToken": CSRF_TOKEN },
          success: function (res) {
            showToast("Task updated successfully!");
            $("#taskActionModal").fadeOut(150);
            loadProjectDetail(currentProjectId);
          }
        });
      });

      // --- Comments ---
      function loadComments(taskId) {
        if (!taskId) return;
        $("#commentsList").html("Loading...");
        $.get(`/tasks/api/comments/get-comments/${taskId}/`, function (res) {
          $("#commentsList").empty();
          if (!res.comments || res.comments.length === 0) {
            $("#commentsList").html('<div style="text-align:center; color:#999; padding:10px;">No comments yet</div>');
            return;
          }
          res.comments.forEach(c => {
            $("#commentsList").append(`
                <div class="comment-item">
                  <div class="comment-header"><strong>${c.user}</strong> <span class="time">${c.created_at}</span></div>
                  <div>${c.comment}</div>
                </div>
              `);
          });
        });
      }

      $("#sendCommentBtn").on("click", function () {
        const text = $("#newComment").val().trim();
        if (!text) return;
        $.ajax({
          url: `/tasks/api/comment/add-comment/`,
          type: "POST",
          contentType: "application/json",
          headers: { "X-CSRFToken": CSRF_TOKEN },
          data: JSON.stringify({ task_id: selectedTaskId, comment: text }),
          success: function (res) {
            $("#newComment").val("");
            loadComments(selectedTaskId);
          }
        });
      });

      // --- Status Workflow ---
      function loadStatusFlow(taskId) {
        if (!taskId) return;
        $.get(`/tasks/api/task/get-status/${taskId}/`, function (res) {
          const currentIdx = statusOrder.indexOf(res.task_status);
          $(".workflow-status-box").removeClass("active");
          $("#status" + currentIdx).addClass("active");

          if (currentIdx === statusOrder.length - 1) {
            $("#nextBtn").prop("disabled", true).text("Completed");
          } else {
            $("#nextBtn").prop("disabled", false).text("Move to Next Stage");
          }
        });
      }

      $("#nextBtn").click(function () {
        $.ajax({
          url: `/tasks/api/task/update-task/${selectedTaskId}/`,
          type: "POST",
          headers: { "X-CSRFToken": CSRF_TOKEN },
          success: function (res) { loadStatusFlow(selectedTaskId); loadProjectDetail(currentProjectId); }
        });
      });

      // --- Activity Log ---
      function loadActivityLog(taskId) {
        if (!taskId) return;
        $("#activityList").html("Loading...");
        $.get(`/tasks/api/task/get-activitylog/${taskId}/`, function (res) {
          $("#activityList").empty();
          if (!res.activity_log || res.activity_log.length === 0) {
            $("#activityList").html('<div style="text-align:center; color:#999;">No activity recorded</div>');
            return;
          }
          res.activity_log.forEach(log => {
            $("#activityList").append(`
                <div class="activity-item">
                  <div><b>${log.user}</b> ${log.action}</div>
                  <small>${log.created_at}</small>
                </div>
              `);
          });
        });
      }

      function loadUsers(page = 1, limit = 10) {
        $.get(`/tasks/admin/manage_user?page=${page}&limit=${limit}`, function (res) {
          const tbody = $("#usersTableBody");
          tbody.empty();

          res.users.forEach(u => {
            tbody.append(`
                <tr>
                  <td>${u.id}</td>
                    <td>${u.full_name}</td>
                    <td>${u.username}</td>
                    <td>${u.email}</td>
                    <td>${u.role}</td>
                    <td>${u.created_by}</td>
                    <td>${u.created_at}</td>
                    <td>${u.note}</td>
                </tr>
            `);
          });

          renderPaginationuser(res);
        });
      }

      function renderPaginationuser(res) {
        let paginationDiv = $("#pagination1");
        if (paginationDiv.length === 0) {
          $(".section.active").append(
            `<div id="pagination1" class="pagination-container"></div>`
          );
          paginationDiv = $("#pagination1");
        }
        paginationDiv.empty();


        let prevDisabled = res.has_previous ? "" : "disabled";
        let nextDisabled = res.has_next ? "" : "disabled";

        paginationDiv.append(`
                <button class="page-btn" ${prevDisabled} data-page="${res.previous_page}"><i class="fa fa-chevron-left"></i> Prev</button>
                <span class="page-info"> Page ${res.page} of ${res.total_pages} </span>
                <button class="page-btn" ${nextDisabled} data-page="${res.next_page}">Next <i class="fa fa-chevron-right"></i></button>
            `);

        $(".page-btn").on("click", function () {
          const p = $(this).data("page");

          if (p) loadUsers(p);
        });
      }
      // --- Roles List ---
      function loadRolesList() {
        $("#rolesTableBody").html('<tr><td colspan="3" style="text-align:center; padding: 20px;">Loading...</td></tr>');
        $.ajax({
          url: "/tasks/admin/manage_role",
          type: "GET",
          dataType: "json",
          success: function (response) {
            const $tbody = $("#rolesTableBody").empty();
            let roles = response.roles || [];

            if (roles.length === 0) {
              $tbody.html('<tr><td colspan="3" style="text-align:center; padding: 20px;">No roles found</td></tr>');
              return;
            }

            roles.forEach(r => {
              $tbody.append(`
                  <tr>
                    <td>${r.id}</td>
                    <td>${r.name}</td>
                    <td>
                        <button class="action-btn edit-role-btn" data-id="${r.id}" data-name="${r.name}"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-role-btn" data-id="${r.id}" style="color: #d32f2f;"><i class="fas fa-trash"></i></button>
                    </td>
                  </tr>
                `);
            });
          },
          error: function (xhr) {
            $("#rolesTableBody").html('<tr><td colspan="3" style="text-align:center; color:red; padding: 20px;">Error loading roles</td></tr>');
          }
        });
      }

      // Add Role
      $("#openAddRoleModalBtn").click(function () { $("#addRoleModal").fadeIn(150); });
      $("#addRoleModal .close").click(function () { $("#addRoleModal").fadeOut(150); });

      $("#addRoleForm").submit(function (e) {
        e.preventDefault();
        $.ajax({
          url: "/tasks/admin/role",
          type: "POST",
          data: $(this).serialize(),
          headers: { "X-CSRFToken": CSRF_TOKEN },
          success: function (res) {
            showToast("Role added successfully");
            $("#addRoleModal").fadeOut(150);
            $("#addRoleForm")[0].reset();
            loadRolesList();
          }
        });
      });

      // Edit Role
      $(document).on("click", ".edit-role-btn", function () {
        const id = $(this).data("id");
        const name = $(this).data("name");
        $("#editRoleForm [name=role_id]").val(id);
        $("#editRoleForm [name=role_name]").val(name);
        $("#editRoleModal").fadeIn(150);
      });
      $("#editRoleModal .close").click(function () { $("#editRoleModal").fadeOut(150); });

      $("#editRoleForm").submit(function (e) {
        e.preventDefault();
        $.ajax({
          url: "/tasks/admin/edit_role",
          type: "POST",
          data: $(this).serialize(),
          headers: { "X-CSRFToken": CSRF_TOKEN },
          success: function (res) {
            showToast("Role updated successfully");
            $("#editRoleModal").fadeOut(150);
            loadRolesList();
          }
        });
      });

      // Delete Role
      $(document).on("click", ".delete-role-btn", function () {
        const id = $(this).data("id");
        $("#deleteRoleForm [name=role_id]").val(id);
        $("#deleteRoleModal").fadeIn(150);
      });
      $("#deleteRoleModal .close, #cancelDeleteRoleBtn").click(function () { $("#deleteRoleModal").fadeOut(150); });

      $("#deleteRoleForm").submit(function (e) {
        e.preventDefault();
        $.ajax({
          url: "/tasks/admin/delete_role",
          type: "POST",
          data: $(this).serialize(),
          headers: { "X-CSRFToken": CSRF_TOKEN },
          success: function (res) {
            showToast("Role deleted successfully");
            $("#deleteRoleModal").fadeOut(150);
            loadRolesList();
          }
        });
      });

      // ------- Add User Modal & Validation -------
      $("#openAddUserModalBtn").on("click", function () {
        $("#addUserModal").fadeIn(150);
      });

      $("#addUserModal .close").on("click", function () {
        $("#addUserModal").fadeOut(150);
        $("#addUserForm")[0].reset();
        $("#u_usernameMsg, #u_passwordMsg, #u_emailMsg").text("");
      });

      let usernameValid = false;
      let emailValid = false;
      let passwordValid = false;

      function toggleUserSubmit() {
        $("#submitUserBtn").prop("disabled", !(usernameValid && emailValid && passwordValid));
      }

      $("#u_username").on("keyup blur", function () {
        let username = $(this).val().trim();
        if (username.length < 4) {
          $("#u_usernameMsg").text("Username must be 4+ chars").css("color", "red");
          usernameValid = false;
          toggleUserSubmit();
          return;
        }
        $.ajax({
          url: "/api/check-username/",
          type: "GET",
          data: { username: username },
          success: function (res) {
            if (res.exists) {
              $("#u_usernameMsg").text("Username already exists").css("color", "red");
              usernameValid = false;
            } else {
              $("#u_usernameMsg").text("Available").css("color", "green");
              usernameValid = true;
            }
            toggleUserSubmit();
          }
        });
      });

      $("#u_email").on("keyup blur", function () {
        const email = $(this).val().trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          $("#u_emailMsg").text("Invalid email format").css("color", "red");
          emailValid = false;
          toggleUserSubmit();
          return;
        }
        $.ajax({
          url: "/api/check-email/",
          type: "GET",
          data: { email: email },
          success: function (res) {
            if (res.exists) {
              $("#u_emailMsg").text("Email already exists").css("color", "red");
              emailValid = false;
            } else {
              $("#u_emailMsg").text("Available").css("color", "green");
              emailValid = true;
            }
            toggleUserSubmit();
          }
        });
      });

      $("#u_password").on("keyup blur", function () {
        const password = $(this).val();
        passwordValid = password.length >= 8 && /[A-Z]/.test(password) && /[a-z]/.test(password) && /\d/.test(password) && /[@$!%*?&]/.test(password);

        if (passwordValid) {
          $("#u_passwordMsg").text("Strong password").css("color", "green");
        } else {
          $("#u_passwordMsg").text("Min 8 chars, upper, lower, number & special").css("color", "red");
        }
        toggleUserSubmit();
      });

      $("#addUserForm").on("submit", function (e) {
        e.preventDefault();
        const formData = $(this).serialize();

        $.ajax({
          url: "/tasks/admin/add_user", // Using existing view, assuming it handles POST
          type: "POST",
          data: formData,
          headers: { "X-CSRFToken": CSRF_TOKEN },
          success: function (res) {
            showToast("User created successfully!");
            $("#addUserModal").fadeOut(150);
            $("#addUserForm")[0].reset();
            loadUsers();
          },
          error: function (xhr) {
            showToast("Error creating user", true);
          }
        });
      });

      // ------- Assign Users Modal Logic -------
      $("#assignUserModal .close").on("click", function () {
        $("#assignUserModal").fadeOut(150);
      });

      // Event delegation for assign button
      $(document).on("click", ".open-assign-modal", function (e) {
        e.stopPropagation();
        const projectId = $(this).data("project-id");
        const projectName = $(this).data("project-name");

        $("#assignProjectName").text(projectName);
        $("#assignUserModal").data("project-id", projectId).fadeIn(150);
        loadAssignUsers(projectId);
      });

      function loadAssignUsers(projectId) {
        $("#assignUserGrid").html('<div style="grid-column: 1/-1; text-align:center;">Loading...</div>');
        $.ajax({
          url: `/tasks/admin/project/api/get_project_users_admin/${projectId}/`,
          type: "GET",
          success: function (res) {

            let html = `<div class="assign-box"><h4>Assigned Users</h4>`;
            if (res.assigned_users.length === 0) {
              html += `<div class="assign-empty">No users assigned</div>`;
            } else {
              res.assigned_users.forEach(u => {
                html += `<div class="assign-user-row">
                                <span>${u.username}</span>
                                <button class="assign-action-btn btn-unassign" data-user="${u.id}">Unassign</button>
                            </div>`;
              });
            }
            html += `</div><div class="assign-box"><h4>Available Users</h4>`;
            if (res.unassigned_users.length === 0) {
              html += `<div class="assign-empty">All users assigned</div>`;
            } else {
              res.unassigned_users.forEach(u => {
                html += `<div class="assign-user-row">
                                <span>${u.username}</span>
                                <button class="assign-action-btn btn-assign" data-user="${u.id}">Assign</button>
                            </div>`;
              });
            }
            html += `</div>`;
            $("#assignUserGrid").html(html);
          },
          error: function (xhr) {
            $("#assignUserGrid").html('<div style="color:red; text-align:center;">Error loading users</div>');
          }
        });
      }


      $(document).on("click", ".btn-assign", function () {
        const userId = $(this).data("user");
        const projectId = $("#assignUserModal").data("project-id");
        $.post("/tasks/admin/project/api/assign_user/", {
          project_id: projectId, user_id: userId, csrfmiddlewaretoken: CSRF_TOKEN
        }, function () {
          loadAssignUsers(projectId);
          loadProjectDetail(projectId); // Refresh main view
        });
      });

      $(document).on("click", ".btn-unassign", function () {
        const userId = $(this).data("user");
        const projectId = $("#assignUserModal").data("project-id");
        $.post("/tasks/admin/project/api/unassign_user/", {
          project_id: projectId, user_id: userId, csrfmiddlewaretoken: CSRF_TOKEN
        }, function () {
          loadAssignUsers(projectId);
          loadProjectDetail(projectId); // Refresh main view
        });
      });

      // Set Projects as default
      const projectsSection = document.querySelector(
        '[data-section="projects"]'
      );
      if (projectsSection) {
        projectsSection.click();
      }

      // ------- Add Project button & modal -------
      $("#addProjectBtn").on("click", function () {
        $("#projectModal").fadeIn(150);
      });

      $("#projectModal .close").on("click", function () {
        $("#projectModal").fadeOut(150);
        $("#projectForm")[0].reset();
      });

      $("#projectForm").on("submit", function (e) {
        e.preventDefault();

        const payload = {
          title: $(this).find("[name='title']").val(),
          detail: $(this).find("[name='description']").val(),
          created_by: getCookie("user_id")
        };

        // optional: disable submit to prevent duplicates
        const $btn = $(this).find("button[type='submit']").prop("disabled", true);

        $.ajax({
          url: "/tasks/admin/api/project/",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(payload),
          headers: { "X-CSRFToken": CSRF_TOKEN },
          success: function (res) {
            $("#projectModal").fadeOut(150);
            $("#projectForm")[0].reset();
            showToast("Project created successfully!");
            loadProjectsList(); // refresh the projects list to include the new project
          },
          error: function (xhr) {
            showToast("Error creating project: " + (xhr.responseText || xhr.statusText), true);
          },
          complete: function () {
            $btn.prop("disabled", false);
          },
        });
      });


      function loadProjectsList() {
        $.ajax({
          url: "/tasks/admin/project/api/get_projects/",
          type: "GET",
          dataType: "json",
          success: function (response) {
            // Parse response flexibly: backend may return an array, an object with
            // `projects` that is a JSON-string, or other shapes.
            let projectData = [];
            try {
              if (!response) {
                projectData = [];
              } else if (Array.isArray(response)) {
                projectData = response;
              } else if (response.projects) {
                if (typeof response.projects === "string") {
                  projectData = JSON.parse(response.projects);
                } else if (Array.isArray(response.projects)) {
                  projectData = response.projects;
                }
              } else if (response.data && Array.isArray(response.data)) {
                projectData = response.data;
              } else if (response.pk || response.id) {
                projectData = [response];
              }
            } catch (err) {
              console.error("Failed to parse projects response", err, response);
              projectData = [];
            }

            const projectsContainer = document.querySelector(".projects-items-wrapper");
            if (!projectsContainer) return;

            // Remove existing project-item elements
            projectsContainer.innerHTML = "";

            if (!projectData || projectData.length === 0) {
              const emptyEl = document.createElement("div");
              emptyEl.className = "project-item";
              emptyEl.innerHTML =
                '<div class="project-name">No projects found</div>';
              projectsContainer.appendChild(emptyEl);
              return;
            }

            // Add projects from API
            projectData.forEach((item, index) => {

              const title =
                (item.fields && item.fields.title) ||
                item.title ||
                item.name ||
                "Untitled";
              const status =
                (item.fields && item.fields.status) || item.fields.detail || "Active";
              const pk = item.pk || item.id || item.project_id;


              const projectEl = document.createElement("div");
              projectEl.className =
                "project-item" + (index === 0 ? " active" : "");
              projectEl.setAttribute("data-project", pk);
              projectEl.innerHTML = `
                        <div>
                            <div class="project-name">${title}</div>
                            <div class="project-status">${status}</div>
                        </div>
                        <a class="assign-btn-list open-assign-modal" data-project-id="${pk}" data-project-name="${title}" title="Assign Users" href='admin/assign_users?project_id=${item.pk}'>
                            <i class="fas fa-user-plus"></i>
                        </a>
                    `;

              projectEl.addEventListener("click", function () {
                document
                  .querySelectorAll(".project-item")
                  .forEach(i => i.classList.remove("active"));

                this.classList.add("active");

                currentProjectId = pk;

                // Update project header
                document.querySelector(".page-title").textContent = title;


                //  Set into DOM for pagination lookup
                $("#projectInfo").data("project-id", pk);

                loadProjectDetail(pk);
              });
              if (index === 0) {
                projectEl.classList.add("active");
              }
              projectsContainer.appendChild(projectEl);
            });
            const firstItem = projectData[0];
            const firstPk = firstItem.pk || firstItem.id || firstItem.project_id;


            if (firstPk) {
              currentProjectId = firstPk;
              $("#projectInfo").data("project-id", currentProjectId);
              loadProjectDetail(firstPk);

              document.querySelector(".page-title").textContent =
                (firstItem.fields && firstItem.fields.title) ||
                firstItem.title ||
                firstItem.name ||
                "Untitled";
            }
          },
        });
      }

      function loadProjectDetail(projectId, page = 1, limit = 10) {
        // $.ajax({
        //   url: `/tasks/api/project/${projectId}/tasks/?page=${page}&limit=${limit}`,
        //   type: "GET",
        //   dataType: "json",
        //   success: function (response) {
        //     try {

        //       const payload = response.project || response || {};
        //       setProjectUsers(payload);
        //     } catch (err) {
        //       console.error("Error processing project detail", err, response);
        //     }
        //   },
        //   error: function (xhr) {
        //     console.error("Error loading project detail:", xhr.responseText);
        //   },
        // });

        const searchType = $("#searchType").val();
        let query = `page=${page}&limit=${limit}`;

        if (searchType === "title") {
          const title = $("#searchInput").val();
          if (title) query += `&title=${encodeURIComponent(title)}`;
        }
        if (searchType === "priority") {
          const val = $("#priorityFilter").val();
          if (val) query += `&priority=${val}`;
        }
        if (searchType === "status") {
          const val = $("#statusFilter").val();
          if (val) query += `&status=${encodeURIComponent(val)}`;
        }
        console.log(query);
        

        $.get(`/tasks/api/project/${projectId}/tasks/?${query}`, function (res) {
          setProjectUsers(res);
        });
      }

      function setProjectUsers(response) {
        
        // Fill header/detail fields
        const name =
          response.project.title ||
          response.name ||
          (response.fields && response.fields.title) ||
          "";
        const desc =
          response.project.title ||
          response.description ||
          (response.fields && response.fields.description) ||
          "";
        const statusText =
          response.status || (response.fields && response.fields.status) || "";
        const progress = response.progress || response.progress_percent || "";


        $("#detail-project-name").text(name);
        $("#detail-project-desc").text(desc);
        $("#detail-project-status").text(
          statusText || (statusText === "" ? "" : "")
        );
        if (progress) $(".detail-progress").text(progress);

        // Users
        const $usersList = $(".users-list").empty();
        const users =
          response.users || response.user_list || response.assigned_users || [];

        if (!users || users.length === 0) {
          $usersList.append(
            `<div class="user-badge"><i class="fas fa-user-circle"></i><span>No users assigned</span></div>`
          );
        } else {
          users.forEach((u) => {
            const label = u.full_name || u.username || u.name || "-";
            const role = u.role || u.designation || "";
            $usersList.append(`
                    <div class="user-badge">
                        <i class="fas fa-user-circle"></i>
                        <span>${label}</span>
                        ${role ? `<small>${role}</small>` : ""}
                    </div>
                `);
          });
        }


        // Tasks
        const $tasksBody = $("#projectTasksBody").empty();
        const tasks = response.tasks || response.task_list || [];
        if (!tasks || tasks.length === 0) {
          $tasksBody.append(`<tr><td colspan="6">No tasks</td></tr>`);
        } else {
          tasks.forEach((t) => {
            let assignedTo = t.assigned_to ?? "-";
            let createdBy = t.created_by ?? "-";
            let updatedBy = t.updated_by ?? "-";


            let overdueBadge = "";
            if (t.is_overdue) {
              overdueBadge = `<span class="overdue-badge">Overdue by ${t.overdue_days} days</span>`;
            }

            if (t.is_overdue) {
              overdueBadge = `<span class="overdue-badge">Overdue by ${t.overdue_days} days</span>`;
            }

            let statusClass =
              "badge-status-" +
              t.status.replace(/\s+/g, "-").toLowerCase();
            if (t.is_overdue && t.status !== "Done")
              statusClass = "badge-status-overdue";

            let priorityClass =
              "badge-priority-" + (t.priority || "low").toLowerCase();

            let commentBadge = "";
            if (t.comment_count > 0) {
              commentBadge = `<span class="comment-count">${t.comment_count}</span>`;
            }
            const taskId = t.id || t.pk || "" || t.task_id

            const title = t.title || t.name || "";
            const assignee =
              t.assigned_to_name ||
              t.assigned_to ||
              t.assigned_to_username ||
              "-";
            const status = (t.status || "").toLowerCase();
            const due = t.due_date || t.due || "-";
            const priority = (t.priority || "").toLowerCase();

            const statusCls =
              status === "completed"
                ? "completed"
                : status === "in progress" || status === "in-progress"
                  ? "in-progress"
                  : "pending";
            const priorityCls =
              priority === "high"
                ? "high"
                : priority === "medium"
                  ? "medium"
                  : "low";

            $tasksBody.append(`
                    <tr class="${t.is_overdue ? "row-overdue" : ""}">
                        <td>
                                    ${t.title}<br>
                                    ${overdueBadge}
                                </td>
                                <td>
                                    <span class="badge ${priorityClass}">${t.priority}</span>
                                </td>
                                <td>
                                    <span class="badge ${statusClass}">${t.status}</span>
                                </td>
                                <td>${assignedTo}</td>
                                <td>${t.due_date}</td>
                                <td>${createdBy}</td>
                                <td>${updatedBy}</td>
                        <td><button class="action-btn" data-task-id="${taskId}"><i class="fas fa-ellipsis-v"></i></button></td>
                    </tr>
                `);

          });
          renderPagination(response);
        }

      }
      function renderPagination(res) {


        let paginationDiv = $("#pagination");

        if (paginationDiv.length === 0) {
          $(".project-tasks").append(
            `<div id="pagination" class="pagination-container"></div>`
          );
          paginationDiv = $("#pagination");
        }
        paginationDiv.empty();

        let prevDisabled = res.has_previous ? "" : "disabled";
        let nextDisabled = res.has_next ? "" : "disabled";

        paginationDiv.append(`
                <button class="page-btn" ${prevDisabled} data-page="${res.previous_page}"><i class="fa fa-chevron-left"></i> Prev</button>
                <span class="page-info"> Page ${res.page} of ${res.total_pages} </span>
                <button class="page-btn" ${nextDisabled} data-page="${res.next_page}">Next <i class="fa fa-chevron-right"></i></button>
            `);

        $(".page-btn").on("click", function () {
          const p = $(this).data("page");

          currentProjectId = $("#projectInfo").data("project-id");

          if (p) loadProjectDetail(currentProjectId, p);
        });
      }

      // Handle navigation item clicks
      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", function (e) {
          e.preventDefault();

          const sectionName = this.getAttribute("data-section");
          const sectionId = sectionName + "-section";

          // Update active nav item
          document
            .querySelectorAll(".nav-item")
            .forEach((i) => i.classList.remove("active"));
          this.classList.add("active");

          // Hide all sections, show selected section
          document.querySelectorAll(".section").forEach((section) => {
            section.classList.remove("active");
          });
          document.getElementById(sectionId).classList.add("active");

          // Update page title
          const titleMap = {
            projects: "Projects",
            users: "Users",
            roles: "Roles",
          };
          document.querySelector(".page-title").textContent =
            titleMap[sectionName];

          if (sectionName === 'users') {
            loadUsers();
          }
          if (sectionName === 'roles') {
            loadRolesList();
          }
        });
      });

      $("#searchType").on("change", function () {
        const type = $(this).val();

        $("#searchInput").toggle(type === "title");
        $("#priorityFilter").toggle(type === "priority");
        $("#statusFilter").toggle(type === "status");

        // Trigger new filter on change
        applyFilters();
      });

      $("#searchInput, #priorityFilter, #statusFilter").on("input change", function () {
        applyFilters();
      });

      function applyFilters() {
        currentProjectId = $("#projectInfo").data("project-id");
        if(currentProjectId) loadProjectDetail(currentProjectId);
      }
    });

    const toggleBtn = document.getElementById("navToggle");
    const sidebar = document.querySelector(".sidebar");
    const toggleIcon = toggleBtn.querySelector("i");

    toggleBtn.addEventListener("click", () => {
      sidebar.classList.toggle("collapsed");
      if (sidebar.classList.contains("collapsed")) {
        toggleIcon.classList.remove("fa-arrow-left");
        toggleIcon.classList.add("fa-arrow-right");
      } else {
        toggleIcon.classList.remove("fa-arrow-right");
        toggleIcon.classList.add("fa-arrow-left");
      }
    });
  </script>
</body>

</html>